---
title: "PhILR"
author: "John Sterrett"
date: "2023-01-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse,
               data.table,
               ggplot2,
               phyloseq,
               qiime2R,
               philr,
               glmnet,
               ggtree,
               patchwork)
```

# Load data
```{r}
pseq <- qiime2R::qza_to_phyloseq(features="Data/noMito_noChloro-filtered-table.qza",
                         taxonomy="Data/taxonomy-silva.qza",
                         tree="Data/insertion-tree.qza",
                         metadata="Data/IBS-metadata.txt")

```

# Filter low-abundance ASVs
```{r}
orig.asvs <- nrow(otu_table(pseq))
# keep only the ASVs found in more than 10% of samples

pseq.filt <- filter_taxa(pseq, 
                         function(x) sum(x>0) > (0.1*length(x)), 
                         prune=T
                         )
presence.filt.remaining <- nrow(otu_table(pseq.filt))

# keep only the ASVs that we have at least 100 reads of
pseq.filt <- filter_taxa(pseq.filt, 
                         function(x) sum(x) > 100, 
                         prune=T
                         )
phylo.filt.final.remaining <- nrow(otu_table(pseq.filt))

# filter taxa that aren't very variable
pseq.filt <- filter_taxa(pseq.filt, 
                         function(x) sd(x)/mean(x) > 3.0, 
                         prune=T
                         )

phylo.filt.final.remaining.variable <- nrow(otu_table(pseq.filt))

cat(paste("Original features:", orig.asvs,
            "\nAfter first filtering step:", presence.filt.remaining,
            "\nAfter second filtering step:", phylo.filt.final.remaining,
            "\nAfter third (variability) filtering step:", phylo.filt.final.remaining.variable))

pseq.filt # check n features

# add pseudocount
temp.tab <- otu_table(pseq.filt) %>% as.data.frame()
temp.tab[temp.tab==0] <- 1
otu_table(pseq.filt) <- otu_table(temp.tab, taxa_are_rows=T)

# check there are no zeros
head(otu_table(pseq.filt))
```

# Process Tree
```{r}
if(ape::is.rooted(phy_tree(pseq.filt)) == T){
    "Tree is rooted."
} else {
    "TREE IS NOT ROOTED"
}

if(ape::is.binary(phy_tree(pseq.filt)) == T){
    "Tree is binary."
} else {
    "TREE IS NOT BINARY"
}

# rename nodes to be "n1, n2, ..."
tree <- ape::makeNodeLabel(phy_tree(pseq.filt), method="number", prefix='n')
phy_tree(pseq.filt) <- tree

# name a balance to check
name.balance(tree, tax_table(pseq.filt), 'n1')

```

# Perform PhILR
```{r}
philr.dat <- philr(otu_table(pseq.filt) %>% t(), # have to transpose the otu table
                  phy_tree(pseq.filt),
                  part.weights='enorm.x.gm.counts', 
                  ilr.weights='blw.sqrt')

metadata <- sample_data(pseq.filt) %>% as.data.frame()

glmmod <- glmnet(x=philr.dat,
                 y=metadata$TOTAL.EST.HFCS..per.year.in.grams.,
                 alpha=1
                 )
top.coords <- as.matrix(coef(glmmod, s=3000))
(top.coords <- top.coords[2:length(top.coords),])

top.coords <- top.coords[order(abs(top.coords), decreasing=T)]
top.coords <- top.coords[top.coords != 0]
top.coords.values <- top.coords
top.coords <- names(top.coords)

# get summary stats for selected features regression
m.formula <- paste(top.coords, collapse=" + ")
m.formula <- paste0("metadata$TOTAL.EST.HFCS..per.year.in.grams. ~ ", m.formula)
m <- lm(as.formula(m.formula),
        data=as.data.frame(philr.dat))
summary(m)

tc.names <- sapply(top.coords, function(x) name.balance(phy_tree(pseq.filt), tax_table(pseq.filt), x))
tc.names

```

# Tree
```{r}
tc.nn <- name.to.nn(phy_tree(pseq.filt), top.coords)
tc.colors <- c('#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99')

p <- ggtree(tree) +
    geom_balance(node=tc.nn[1], fill=tc.colors[1], alpha=0.6) +
    geom_balance(node=tc.nn[2], fill=tc.colors[2], alpha=0.6) +
    geom_balance(node=tc.nn[3], fill=tc.colors[3], alpha=0.6) +
    geom_balance(node=tc.nn[4], fill=tc.colors[4], alpha=0.6) +
    geom_balance(node=tc.nn[5], fill=tc.colors[5], alpha=0.6)

p <- annotate_balance(tr=phy_tree(pseq.filt), coord=top.coords[1], 
                 p=p, 
                 labels=paste(rep(top.coords[1],2), c("num", "denom")),
                 offset.text=0.15, bar=FALSE)
p <- annotate_balance(tr=phy_tree(pseq.filt), coord=top.coords[2], 
                 p=p, 
                 labels=paste(rep(top.coords[2],2), c("num", "denom")),
                 offset.text=0.15, bar=FALSE)

p <- annotate_balance(tr=phy_tree(pseq.filt), coord=top.coords[3], 
                 p=p, 
                 #labels=paste(rep(top.coords[3],2), c("num", "denom")),
                 labels=c("", "n15"),
                 offset.text=0.05, bar=FALSE)
p <- annotate_balance(tr=phy_tree(pseq.filt), coord=top.coords[4], 
                 p=p, 
                 #labels=paste(rep(top.coords[4],2), c("num", "denom")),
                 labels=c("n2",""),
                 offset.text=0.05, bar=FALSE)
p <- annotate_balance(tr=phy_tree(pseq.filt), coord=top.coords[5], 
                 p=p, 
                 labels=paste(rep(top.coords[5],2), c("num", "denom")),
                 #labels=c("",""),
                 offset.text=0.15, bar=FALSE)
p

```

# Boxplots
```{r, fig.height=10, fig.width=14}
philr.long <- convert_to_long(philr.dat, labels=metadata$TOTAL.EST.HFCS..per.year.in.grams.) %>%
  filter(coord %in% top.coords)

philr.long$coord <- factor(philr.long$coord,
                           levels=c("n14", "n55", "n15", "n119", "n2")) 

scatter.labels <- paste(names(tc.names), tc.names, sep=": ")
names(scatter.labels) <- names(tc.names)

p2 <- ggplot(philr.long, aes(x=labels, y=value, color=coord)) +
  geom_point() +
  scale_color_manual(guide="none", values = c('#a6cee3', '#1f78b4', '#b2df8a', '#fb9a99', '#33a02c')) +
  facet_wrap(.~coord,
             scales='free', ncol=1,
             labeller=labeller(coord=scatter.labels)) +
  labs(x = 'Estimated HFCS (g/month)', y = 'Balance Value') +
  scale_x_continuous(labels = scales::comma) +
  theme_bw()

p + p2 + plot_layout(widths = c(2, 1))

ggsave("Figures/HFCS_PhILR.pdf", height=10, width=14)
```

# Balance contents {.tabset}
```{r, results='asis'}

asv.node <- philr(otu_table(pseq.filt) %>% t(), # have to transpose the otu table
                  phy_tree(pseq.filt),
                  part.weights='enorm.x.gm.counts', 
                  ilr.weights='blw.sqrt',return.all=T)$sbp

tax.table <- tax_table(pseq.filt) %>% as.data.frame()


make_num_summary <- function(curr.node){
    num <- this.node[this.node==1]
    num.asvs <- names(num)
    
    tax.table[num.asvs,] %>% 
        as.data.table() %>% 
        mutate_all(as.factor) %>% 
        summary() %>% knitr::kable()
}

make_num_full <- function(curr.node){
    num <- this.node[this.node==1]
    num.asvs <- names(num)
    
    tax.table[num.asvs,] %>% knitr::kable()
}


make_denom_summary <- function(curr.node){
    denom <- this.node[this.node==-1]
    denom.asvs <- names(denom)
    
    tax.table[denom.asvs,] %>% 
        as.data.table() %>% 
        mutate_all(as.factor) %>% 
        summary() %>% knitr::kable()
}

make_denom_full <- function(curr.node){
    denom <- this.node[this.node==-1]
    denom.asvs <- names(denom)
    
    tax.table[denom.asvs,] %>% knitr::kable()
}



```
## n14 {.tabset}
```{r}
c <- "n14"

this.node <- asv.node[,c]

```

### Numerator summary
```{r}
make_num_summary(this.node)
```
### Numerator full table
```{r}
make_num_full(this.node)
```
### Denominator summary
```{r}
make_denom_summary(this.node)
```
### Denominator full table
```{r}
make_denom_full(this.node)
```

## n55 {.tabset}
```{r}
c <- "n55"

this.node <- asv.node[,c]

```

### Numerator summary
```{r}
make_num_summary(this.node)
```
### Numerator full table
```{r}
make_num_full(this.node)
```
### Denominator summary
```{r}
make_denom_summary(this.node)
```
### Denominator full table
```{r}
make_denom_full(this.node)
```

## n15 {.tabset}
```{r}
c <- "n15"

this.node <- asv.node[,c]

```

### Numerator summary
```{r}
make_num_summary(this.node)
```
### Numerator full table
```{r}
make_num_full(this.node)
```
### Denominator summary
```{r}
make_denom_summary(this.node)
```
### Denominator full table
```{r}
make_denom_full(this.node)
```

## n119 {.tabset}
```{r}
c <- "n119"

this.node <- asv.node[,c]

```

### Numerator summary
```{r}
make_num_summary(this.node)
```
### Numerator full table
```{r}
make_num_full(this.node)
```
### Denominator summary
```{r}
make_denom_summary(this.node)
```
### Denominator full table
```{r}
make_denom_full(this.node)
```

## n2 {.tabset}
```{r}
c <- "n2"

this.node <- asv.node[,c]

```

### Numerator summary
```{r}
make_num_summary(this.node)
```
### Numerator full table
```{r}
make_num_full(this.node)
```
### Denominator summary
```{r}
make_denom_summary(this.node)
```
### Denominator full table
```{r}
make_denom_full(this.node)
```