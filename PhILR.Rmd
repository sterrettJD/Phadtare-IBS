---
title: "PhILR"
author: "John Sterrett"
date: "2023-01-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse,
               data.table,
               ggplot2,
               phyloseq,
               qiime2R,
               philr)
```

# Load data
```{r}
pseq <- qiime2R::qza_to_phyloseq(features="Data/noMito_noChloro-filtered-table.qza",
                         taxonomy="Data/taxonomy-silva.qza",
                         tree="Data/insertion-tree.qza",
                         metadata="Data/IBS-metadata.txt")

```

# Filter low-abundance ASVs
```{r}
orig.asvs <- nrow(otu_table(pseq))
# keep only the ASVs found in more than 10% of samples

pseq.filt <- filter_taxa(pseq, 
                         function(x) sum(x>0) > (0.1*length(x)), 
                         prune=T
                         )
presence.filt.remaining <- nrow(otu_table(pseq.filt))

# keep only the ASVs that we have at least 100 reads of
pseq.filt <- filter_taxa(pseq.filt, 
                         function(x) sum(x) > 100, 
                         prune=T
                         )
phylo.filt.final.remaining <- nrow(otu_table(pseq.filt))

# filter taxa that aren't very variable
pseq.filt <- filter_taxa(pseq.filt, 
                         function(x) sd(x)/mean(x) > 3.0, 
                         prune=T
                         )

phylo.filt.final.remaining.variable <- nrow(otu_table(pseq.filt))

cat(paste("Original features:", orig.asvs,
            "\nAfter first filtering step:", presence.filt.remaining,
            "\nAfter second filtering step:", phylo.filt.final.remaining,
            "\nAfter third (variability) filtering step:", phylo.filt.final.remaining.variable))

pseq.filt # check n features

# add pseudocount
temp.tab <- otu_table(pseq.filt) %>% as.data.frame()
temp.tab[temp.tab==0] <- 1
otu_table(pseq.filt) <- otu_table(temp.tab, taxa_are_rows=T)

# check there are no zeros
otu_table(pseq.filt)
```

# 